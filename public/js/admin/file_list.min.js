layui.use(["form","layer","upload","table","laydate"],function(){$=layui.jquery;var g=layui.form;var d=layui.upload;var c=layui.laydate;var f=layui.table;var b={};var e={title:"",id:1,start:0,data:[]};var a=JSON.parse(localStorage.getItem("fileList"));if(!a){a={id:false,origin_name:false,path:true,size_show:false,ext:true,identify_progress_name:false,type_name:false,created_at:false}}g.render();c.render({elem:"#test6",range:true});g.on("submit(sreach)",function(h){b=h.field;console.log(b);f.reload("exportTable",{where:b,page:{curr:1}});return false});f.on("toolbar()",function(h){console.log(h.event);if(h.event==="LAYTABLE_COLS"){$(".layui-table-tool-panel").click(function(){$(".layui-table-tool-panel li").each(function(k,j){a[$(j).find("input").attr("name")]=$(j).find(".layui-form-checked").length===0});localStorage.setItem("fileList",JSON.stringify(a))})}});f.render({elem:"#table",id:"exportTable",limit:15,limits:[15,30,60,90],loading:true,toolbar:"#toolbarDemo",defaultToolbar:["filter"],where:b,url:"/admin/file/list",page:true,cols:[[{field:"id",title:"ID",hide:a.id},{field:"origin_name",title:"原文件名",hide:a.origin_name},{field:"path",title:"附件地址",hide:a.path},{field:"size_show",title:"文件大小",hide:a.size_show},{field:"ext",title:"文件后缀",hide:a.ext},{field:"identify_progress_name",title:"识别进度",hide:a.identify_progress_name},{field:"type_name",title:"发票类型",hide:a.type_name},{field:"created_at",title:"创建时间 ",hide:a.created_at},{field:"id",title:"操作",templet:function(h){let html='<span data-id="'+h.LAY_TABLE_INDEX+'" class="layui-btn layui-btn-sm layui-btn-normal show_img">查看</span>';html+='<a href="/'+h.path+'" target="_blank" class="layui-btn layui-btn-sm" download="'+h.origin_name+'">下载</a>';if(h.identify_progress!==3&&h.identify_progress!==4){html+='<span data-id="'+h.id+'" class="layui-btn layui-btn-sm layui-btn-warm re_identify">识别</span>';html+='<span data-id="'+h.id+'" class="layui-btn layui-btn-sm layui-btn-danger delete_img">删除</span>'}if(h.identify_progress===4){html+='<span data-id="'+h.id+'" class="layui-btn layui-btn-sm layui-btn-danger delete_img">删除</span>'}return html},width:250}]],done:function(h,k,j){$("#size").html(h.sum_size);e.data=[];for(let i in h.data){e.data.push({alt:h.data[i].origin_name,pid:h.data[i].id,src:"/"+h.data[i].img_path,thumb:"/"+h.data[i].img_path})}console.log(e);$(".show_img").click(function(){e.start=$(this).attr("data-id");console.log(e);layer.photos({photos:e,anim:5})});$(".re_identify").click(function(){let id=$(this).attr("data-id");layer.load();$.post("/admin/file/re_identify",{id:id},function(l){if(l.code===0){layer.msg("识别成功",{icon:1});f.reload("exportTable",{where:b,page:{curr:1}});layer.closeAll("loading")}else{layer.msg("识别失败",{icon:2});layer.closeAll("loading")}})});$(".delete_img").click(function(){let id=$(this).attr("data-id");layer.confirm("你确定要删除此文件吗？",{btn:["确定","取消"]},function(){$.post("/admin/file/delete_img",{id:id},function(l){if(l.code===0){layer.msg("删除成功",{icon:1});f.reload("exportTable",{where:b,page:{curr:1}})}else{layer.msg("删除失败",{icon:2})}})})})}})});